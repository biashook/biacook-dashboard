<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BiasCook ìš´ì˜ í˜„í™©íŒ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600;700&family=DM+Serif+Display&display=swap');
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --brown-dark: #6B4226; --brown-mid: #A0522D; --brown-light: #C97B3A;
    --brown-pale: #E8B87A; --cream: #FDF6EE; --cream-light: #FFF8F0;
    --border: #E8D5C0; --text: #3B2A1A; --text-muted: #8B6B4A;
  }
  body { font-family: 'Noto Serif KR', Georgia, serif; background: var(--cream); color: var(--text); min-height: 100vh; }

  .header { background: linear-gradient(135deg, #6B4226 0%, #A0522D 60%, #C97B3A 100%); padding: 24px 28px 20px; box-shadow: 0 4px 20px rgba(107,66,38,0.3); }
  .header-top { display: flex; align-items: center; gap: 14px; margin-bottom: 16px; }
  .header-title { font-family: 'DM Serif Display', serif; font-size: 24px; color: #FFF8F0; }
  .header-sub { font-size: 12px; color: #E8C9A0; margin-top: 3px; }
  .kpi-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; }
  .kpi-card { background: rgba(255,248,240,0.15); border-radius: 12px; padding: 14px 16px; border: 1px solid rgba(255,248,240,0.2); }
  .kpi-icon { font-size: 20px; margin-bottom: 4px; }
  .kpi-value { font-size: 19px; font-weight: 700; color: #FFF8F0; }
  .kpi-label { font-size: 11px; color: #E8C9A0; margin-top: 2px; }
  .kpi-sub { font-size: 10px; color: #C4956A; margin-top: 1px; }

  .tabs { background: var(--cream-light); border-bottom: 2px solid var(--border); padding: 0 28px; display: flex; gap: 4px; }
  .tab-btn { padding: 12px 16px; border: none; background: none; cursor: pointer; font-size: 13px; font-family: inherit; color: var(--text-muted); border-bottom: 3px solid transparent; transition: all 0.2s; }
  .tab-btn.active { color: var(--brown-dark); font-weight: 700; border-bottom-color: var(--brown-light); }

  .content { padding: 22px 28px; }
  .tab-pane { display: none; }
  .tab-pane.active { display: block; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; }

  .card { background: var(--cream-light); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
  .card-header { padding: 14px 18px; background: #F5EDE0; border-bottom: 1px solid var(--border); font-size: 14px; font-weight: 700; color: var(--brown-dark); display: flex; justify-content: space-between; align-items: center; }
  .card-body { padding: 18px; }

  table { width: 100%; border-collapse: collapse; }
  th { padding: 10px 14px; text-align: left; font-size: 12px; color: var(--brown-dark); font-weight: 600; background: #EEE0D0; }
  td { padding: 11px 14px; font-size: 13px; border-bottom: 1px solid #EEE0D0; }
  tr:nth-child(even) td { background: #FDF3EA; }
  tfoot td { background: #E8D5C0 !important; font-weight: 700; font-size: 13px; }

  .badge { padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
  .badge-green { background: #DCFCE7; color: #166534; }
  .badge-amber { background: #FEF9C3; color: #854D0E; }
  .badge-red   { background: #FEE2E2; color: #991B1B; }

  .progress-wrap { background: #EEE0D0; border-radius: 20px; height: 8px; overflow: hidden; margin: 8px 0; }
  .progress-bar { height: 100%; background: linear-gradient(90deg, #C97B3A, #E8B87A); border-radius: 20px; transition: width 0.6s ease; }

  .dev-item { padding: 16px 18px; border-bottom: 1px solid #EEE0D0; }
  .dev-item:last-child { border-bottom: none; }
  .dev-item:nth-child(even) { background: #FDF3EA; }
  .dev-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .dev-name { font-size: 14px; font-weight: 700; }
  .dev-meta { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
  .dev-right { display: flex; gap: 8px; align-items: center; }
  .dev-note { font-size: 12px; color: #7B5B3A; margin-top: 6px; }

  .cafe-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
  .cafe-card { background: var(--cream-light); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; border-left: 4px solid var(--brown-dark); }
  .cafe-card.delay { border-left-color: var(--brown-light); background: #FFF5ED; }
  .cafe-card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .cafe-card-name { font-size: 14px; font-weight: 700; }
  .cafe-card-detail { font-size: 12px; color: var(--text-muted); margin-top: 3px; }
  .cafe-card-amount { font-size: 13px; font-weight: 700; color: var(--brown-light); margin-top: 8px; }

  .quick-list { display: flex; flex-direction: column; gap: 10px; }
  .quick-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border-radius: 8px; background: #F7F0E8; border: 1px solid #E8D5C0; }
  .quick-item.alert { background: #FFF0E8; border-color: #F0C8A0; }
  .quick-label { font-size: 13px; color: #5C4030; }
  .quick-value { font-size: 14px; font-weight: 700; color: var(--brown-dark); }
  .quick-item.alert .quick-value { color: var(--brown-light); }

  .stage-mini { text-align: center; background: var(--cream-light); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
  .stage-dot { width: 12px; height: 12px; border-radius: 50%; margin: 0 auto 8px; }
  .stage-count { font-size: 20px; font-weight: 700; color: var(--brown-dark); }
  .stage-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

  /* â”€â”€ í¸ì§‘ ê´€ë ¨ â”€â”€ */
  .editable {
    cursor: pointer; border-bottom: 1px dashed var(--brown-pale);
    transition: background 0.15s; border-radius: 3px; padding: 1px 3px;
  }
  .editable:hover { background: #FDE8CC; }
  .editable:focus { outline: 2px solid var(--brown-light); background: #FFF3E0; border-bottom: none; border-radius: 4px; }

  select.edit-select {
    font-family: inherit; font-size: 11px; font-weight: 600;
    border: 1px solid var(--brown-light); border-radius: 20px;
    padding: 3px 10px; cursor: pointer; background: #FFF8F0;
    color: var(--brown-dark); outline: none;
  }

  .edit-hint { font-size: 11px; color: var(--text-muted); margin-top: 6px; padding: 6px 12px; background: #F5EDE0; border-radius: 8px; text-align: center; }

  .btn-add { margin: 10px 18px 14px; padding: 8px 16px; background: var(--brown-dark); color: #FFF8F0; border: none; border-radius: 8px; font-family: inherit; font-size: 13px; cursor: pointer; transition: background 0.2s; }
  .btn-add:hover { background: var(--brown-mid); }
  .btn-del { background: none; border: none; color: #CBA; cursor: pointer; font-size: 14px; padding: 0 4px; }
  .btn-del:hover { color: #991B1B; }

  .save-bar { position: fixed; bottom: 20px; right: 24px; background: var(--brown-dark); color: #FFF8F0; padding: 10px 20px; border-radius: 30px; font-size: 13px; box-shadow: 0 4px 16px rgba(107,66,38,0.4); display: none; gap: 10px; align-items: center; z-index: 999; }
  .save-bar.show { display: flex; }
  .save-bar button { background: var(--brown-pale); color: var(--brown-dark); border: none; padding: 5px 14px; border-radius: 20px; font-family: inherit; font-size: 12px; font-weight: 700; cursor: pointer; }

  @media (max-width: 720px) {
    .kpi-grid { grid-template-columns: repeat(2,1fr); }
    .grid-2 { grid-template-columns: 1fr; }
    .grid-4 { grid-template-columns: repeat(2,1fr); }
    .cafe-cards { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-top">
    <span style="font-size:36px">ğŸ¥</span>
    <div>
      <div class="header-title">BiasCook ìš´ì˜ í˜„í™©íŒ</div>
      <div class="header-sub">í™ˆë² ì´ì»¤ ì§€ê¸‰ ê´€ë¦¬ Â· ì œë¹µ ê°œë°œ Â· ì¹´í˜ ë‚©í’ˆ í†µí•© ëŒ€ì‹œë³´ë“œ</div>
    </div>
  </div>
  <div class="kpi-grid">
    <div class="kpi-card"><div class="kpi-icon">ğŸ’¸</div><div class="kpi-value" id="kpi-paid">-</div><div class="kpi-label">ì´ë²ˆ ë‹¬ ì´ ì§€ê¸‰ì•¡</div><div class="kpi-sub">í™ˆë² ì´ì»¤ ì „ì²´</div></div>
    <div class="kpi-card"><div class="kpi-icon">ğŸ“ˆ</div><div class="kpi-value" id="kpi-fee">-</div><div class="kpi-label">ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ (30%)</div><div class="kpi-sub" id="kpi-month">-</div></div>
    <div class="kpi-card"><div class="kpi-icon">ğŸ‘©â€ğŸ³</div><div class="kpi-value" id="kpi-bakers">-</div><div class="kpi-label">í™œì„± í™ˆë² ì´ì»¤</div><div class="kpi-sub" id="kpi-bakers-sub">-</div></div>
    <div class="kpi-card"><div class="kpi-icon">â˜•</div><div class="kpi-value" id="kpi-cafes">-</div><div class="kpi-label">ì •ìƒ ë‚©í’ˆ ì¹´í˜</div><div class="kpi-sub" id="kpi-cafes-sub">-</div></div>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('overview',this)">ğŸ“Š í˜„í™© ê°œìš”</button>
  <button class="tab-btn" onclick="switchTab('ledger',this)">ğŸ’° ì§€ê¸‰ ê°€ê³„ë¶€</button>
  <button class="tab-btn" onclick="switchTab('development',this)">ğŸ§ª ì œë¹µ ê°œë°œ</button>
  <button class="tab-btn" onclick="switchTab('delivery',this)">ğŸšš ë‚©í’ˆ í˜„í™©</button>
</div>

<div class="content">

  <!-- OVERVIEW -->
  <div class="tab-pane active" id="tab-overview">
    <div class="grid-2" style="margin-bottom:18px">
      <div class="card"><div class="card-header">ğŸ“Š ì›”ë³„ ì§€ê¸‰ì•¡ vs ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ</div><div class="card-body"><canvas id="chart-bar" style="max-height:210px"></canvas></div></div>
      <div class="card"><div class="card-header">ğŸ¥§ ì´ë²ˆ ë‹¬ ë² ì´ì»¤ë³„ ì§€ê¸‰ ë¹„ì¤‘</div><div class="card-body"><canvas id="chart-pie" style="max-height:210px"></canvas></div></div>
    </div>
    <div class="grid-2">
      <div class="card"><div class="card-header">ğŸ“ˆ ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ íŠ¸ë Œë“œ</div><div class="card-body"><canvas id="chart-line" style="max-height:200px"></canvas></div></div>
      <div class="card"><div class="card-header">âš¡ ë¹ ë¥¸ í˜„í™©</div>
        <div class="card-body">
          <div class="quick-list">
            <div class="quick-item alert"><span class="quick-label">ë‚©í’ˆ ì§€ì—° ì¹´í˜</span><span class="quick-value" id="q-delay">-</span></div>
            <div class="quick-item"><span class="quick-label">ê°œë°œ ì¤‘ì¸ ì œí’ˆ</span><span class="quick-value" id="q-dev">-</span></div>
            <div class="quick-item alert"><span class="quick-label">ì´ë‹¬ ë¯¸ì§€ê¸‰ ë² ì´ì»¤</span><span class="quick-value" id="q-unpaid">-</span></div>
            <div class="quick-item"><span class="quick-label">í‰ê·  ì¹´í˜ ì›” ë‚©í’ˆì•¡</span><span class="quick-value" id="q-avg">-</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LEDGER -->
  <div class="tab-pane" id="tab-ledger">
    <div class="card" style="margin-bottom:18px">
      <div class="card-header">
        <span>ğŸ’° í™ˆë² ì´ì»¤ ì§€ê¸‰ ë‚´ì—­</span>
        <span style="font-size:12px;font-weight:400;color:var(--text-muted)" id="ledger-month-label"></span>
      </div>
      <div class="edit-hint">âœï¸ ì´ë¦„, í’ˆëª©, ê¸ˆì•¡ì„ í´ë¦­í•˜ë©´ ë°”ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”</div>
      <table>
        <thead><tr><th>ë² ì´ì»¤</th><th>ì „ë¬¸ í’ˆëª©</th><th>ìƒíƒœ</th><th>ì´ë²ˆ ë‹¬ ì§€ê¸‰</th><th>ëˆ„ì  ì§€ê¸‰ì•¡</th><th>ìˆ˜ìˆ˜ë£Œ(30%)</th><th></th></tr></thead>
        <tbody id="baker-tbody"></tbody>
        <tfoot><tr><td colspan="3">í•©ê³„</td><td id="foot-paid">-</td><td id="foot-total">-</td><td id="foot-fee">-</td><td></td></tr></tfoot>
      </table>
      <button class="btn-add" onclick="addBaker()">+ ë² ì´ì»¤ ì¶”ê°€</button>
    </div>
    <div class="card">
      <div class="card-header">ğŸ“Š ì›”ë³„ ì§€ê¸‰/ìˆ˜ìµ ì¶”ì´</div>
      <div class="card-body"><canvas id="chart-bar2" style="max-height:230px"></canvas></div>
    </div>
  </div>

  <!-- DEVELOPMENT -->
  <div class="tab-pane" id="tab-development">
    <div class="card" style="margin-bottom:16px">
      <div class="card-header">ğŸ§ª ì œë¹µ ê°œë°œ ì§„í–‰ í˜„í™©</div>
      <div class="edit-hint">âœï¸ í’ˆëª©ëª…, ì§„í–‰ë¥ , ë‹¨ê³„, ë©”ëª¨ë¥¼ í´ë¦­í•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”</div>
      <div id="dev-list"></div>
      <button class="btn-add" onclick="addDev()">+ ê°œë°œ í’ˆëª© ì¶”ê°€</button>
    </div>
    <div class="grid-4" id="stage-summary"></div>
  </div>

  <!-- DELIVERY -->
  <div class="tab-pane" id="tab-delivery">
    <div class="card" style="margin-bottom:16px">
      <div class="card-header">ğŸšš ì¹´í˜ ë‚©í’ˆ í˜„í™©</div>
      <div class="edit-hint">âœï¸ ì¹´í˜ëª…, ê¸ˆì•¡, ìƒíƒœë¥¼ í´ë¦­í•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”</div>
      <table>
        <thead><tr><th>ì¹´í˜ëª…</th><th>ì§€ì—­</th><th>ë‹´ë‹¹ ë² ì´ì»¤</th><th>ë‚©í’ˆ í’ˆëª©</th><th>ë‚©í’ˆ ì£¼ê¸°</th><th>ìµœê·¼ ë‚©í’ˆì¼</th><th>ì›” ë‚©í’ˆì•¡</th><th>ìƒíƒœ</th><th></th></tr></thead>
        <tbody id="cafe-tbody"></tbody>
        <tfoot><tr><td colspan="6">ì›” ì´ ë‚©í’ˆì•¡</td><td id="cafe-foot-total">-</td><td colspan="2"></td></tr></tfoot>
      </table>
      <button class="btn-add" onclick="addCafe()">+ ì¹´í˜ ì¶”ê°€</button>
    </div>
    <div class="cafe-cards" id="cafe-cards"></div>
  </div>

</div>

<!-- SAVE BAR -->
<div class="save-bar" id="save-bar">
  <span>ğŸ’¾ ë³€ê²½ì‚¬í•­ì´ ìˆì–´ìš”</span>
  <button onclick="saveData()">ì €ì¥í•˜ê¸°</button>
</div>

<div style="text-align:center;padding:16px 0 24px;font-size:11px;color:#B08060">
  BiasCook Â· Food Operating System Â· ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤
</div>

<script>
// â”€â”€ ê¸°ë³¸ ë°ì´í„° â”€â”€
const DEFAULT = {
  bakers: [
    { id:1, name:"ê¹€ë¯¼ì§€", specialty:"ë§ˆì¹´ë¡±", status:"í™œì„±", thisMonth:120000, total:420000 },
    { id:2, name:"ì´ìˆ˜ì—°", specialty:"ìŠ¤ì½˜/íƒ€ë¥´íŠ¸", status:"í™œì„±", thisMonth:95000, total:380000 },
    { id:3, name:"ë°•ì§€í˜„", specialty:"ì¼€ì´í¬", status:"í™œì„±", thisMonth:180000, total:560000 },
    { id:4, name:"ìµœì•„ë¦„", specialty:"ì¿ í‚¤ë¥˜", status:"ëŒ€ê¸°", thisMonth:0, total:200000 },
    { id:5, name:"ì •ì†Œí¬", specialty:"ë¸Œë ˆë“œ", status:"í™œì„±", thisMonth:85000, total:310000 },
  ],
  devs: [
    { id:1, baker:"ë°•ì§€í˜„", item:"ë”¸ê¸° ìƒí¬ë¦¼ ì¼€ì´í¬", stage:"ì¹´í˜ í…ŒìŠ¤íŠ¸", progress:80, deadline:"2026-03-10", note:"ë§› í”¼ë“œë°± ë°˜ì˜ ì¤‘" },
    { id:2, baker:"ê¹€ë¯¼ì§€", item:"ë§ì°¨ ë§ˆì¹´ë¡± ì„¸íŠ¸", stage:"ë ˆì‹œí”¼ ì™„ì„±", progress:60, deadline:"2026-03-20", note:"ìƒ‰ì†Œ ë°°í•© ì¡°ì •" },
    { id:3, baker:"ì´ìˆ˜ì—°", item:"ì–¼ê·¸ë ˆì´ ìŠ¤ì½˜", stage:"ì‹œì œí’ˆ ì œì‘", progress:40, deadline:"2026-04-01", note:"ë²„í„° ë¹„ìœ¨ ì‹¤í—˜" },
    { id:4, baker:"ì •ì†Œí¬", item:"í¬ëœë² ë¦¬ í˜¸ë°€ë¹µ", stage:"ê¸°íš", progress:15, deadline:"2026-04-15", note:"ì›ê°€ ê³„ì‚° í•„ìš”" },
  ],
  cafes: [
    { id:1, name:"Bloom Coffee", region:"ì• í‹€ëœíƒ€", baker:"ë°•ì§€í˜„", item:"ë°ì¼ë¦¬ ì¼€ì´í¬ ìŠ¬ë¼ì´ìŠ¤", freq:"ì£¼ 3íšŒ", lastDate:"2026-02-22", amount:180000, status:"ì •ìƒ" },
    { id:2, name:"The Daily Grind", region:"ìŠ¤í†¤ë§ˆìš´í‹´", baker:"ê¹€ë¯¼ì§€", item:"ë§ˆì¹´ë¡± ì„¸íŠ¸(10ì…)", freq:"ì£¼ 2íšŒ", lastDate:"2026-02-20", amount:120000, status:"ì •ìƒ" },
    { id:3, name:"Porch & Roast", region:"ë””ì¼€ì´í„°", baker:"ì´ìˆ˜ì—°", item:"ìŠ¤ì½˜ ë¯¹ìŠ¤", freq:"ì£¼ 2íšŒ", lastDate:"2026-02-18", amount:95000, status:"ì§€ì—°" },
    { id:4, name:"Oak & Ember", region:"ë§ˆë¦¬ì—íƒ€", baker:"ì •ì†Œí¬", item:"ì‹ì‚¬ë¹µ ëª¨ë‘ ", freq:"ì£¼ 1íšŒ", lastDate:"2026-02-21", amount:85000, status:"ì •ìƒ" },
  ],
  monthly: [
    { month:"9ì›”", paid:280000 }, { month:"10ì›”", paid:350000 }, { month:"11ì›”", paid:420000 },
    { month:"12ì›”", paid:390000 }, { month:"1ì›”", paid:480000 }, { month:"2ì›”", paid:480000 },
  ]
};

let data = JSON.parse(localStorage.getItem('biacook_data') || 'null') || JSON.parse(JSON.stringify(DEFAULT));
let nextId = Math.max(...data.bakers.map(b=>b.id), ...data.devs.map(d=>d.id), ...data.cafes.map(c=>c.id)) + 1;
let changed = false;
let charts = {};
const STAGES = ["ê¸°íš","ë ˆì‹œí”¼ ì™„ì„±","ì‹œì œí’ˆ ì œì‘","ì¹´í˜ í…ŒìŠ¤íŠ¸","ë‚©í’ˆ í™•ì •"];
const STAGE_COLORS = {"ê¸°íš":"#E8D5C0","ë ˆì‹œí”¼ ì™„ì„±":"#C97B3A","ì‹œì œí’ˆ ì œì‘":"#A0522D","ì¹´í˜ í…ŒìŠ¤íŠ¸":"#6B4226","ë‚©í’ˆ í™•ì •":"#3B2A1A"};
const STATUS_BAKER = ["í™œì„±","ëŒ€ê¸°","ì¤‘ë‹¨"];
const STATUS_CAFE  = ["ì •ìƒ","ì§€ì—°","ì¤‘ë‹¨"];

const fmt = n => n > 0 ? 'â‚©' + n.toLocaleString('ko-KR') : '-';
const nowMonth = () => new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long'});

function markChanged() { changed = true; document.getElementById('save-bar').classList.add('show'); }
function saveData() {
  localStorage.setItem('biacook_data', JSON.stringify(data));
  changed = false;
  document.getElementById('save-bar').classList.remove('show');
  render();
}

// â”€â”€ ì¸ë¼ì¸ í¸ì§‘ í—¬í¼ â”€â”€
function editable(value, onSave, type='text') {
  const el = document.createElement(type === 'number' ? 'span' : 'span');
  el.className = 'editable';
  el.contentEditable = 'true';
  el.textContent = value;
  el.addEventListener('blur', () => {
    const v = type === 'number' ? parseInt(el.textContent.replace(/[^0-9]/g,'')) || 0 : el.textContent.trim();
    onSave(v);
    markChanged();
    render();
  });
  el.addEventListener('keydown', e => { if(e.key === 'Enter') { e.preventDefault(); el.blur(); } });
  return el;
}

function statusSelect(value, options, onSave) {
  const sel = document.createElement('select');
  sel.className = 'edit-select';
  options.forEach(opt => {
    const o = document.createElement('option');
    o.value = opt; o.textContent = opt;
    if(opt === value) o.selected = true;
    sel.appendChild(o);
  });
  sel.addEventListener('change', () => { onSave(sel.value); markChanged(); render(); });
  return sel;
}

// â”€â”€ ë Œë” ë©”ì¸ â”€â”€
function render() {
  updateKPI();
  renderBakerTable();
  renderDevList();
  renderCafeTable();
  renderCafeCards();
  renderStageSummary();
  renderCharts();
  document.getElementById('ledger-month-label').textContent = nowMonth() + ' ê¸°ì¤€';
}

// â”€â”€ KPI â”€â”€
function updateKPI() {
  const totalPaid = data.bakers.reduce((a,b) => a + b.thisMonth, 0);
  const active = data.bakers.filter(b => b.status === 'í™œì„±').length;
  const goodCafes = data.cafes.filter(c => c.status === 'ì •ìƒ').length;
  document.getElementById('kpi-paid').textContent = fmt(totalPaid);
  document.getElementById('kpi-fee').textContent = fmt(Math.round(totalPaid * 0.3));
  document.getElementById('kpi-month').textContent = nowMonth() + ' ê¸°ì¤€';
  document.getElementById('kpi-bakers').textContent = active + 'ëª…';
  document.getElementById('kpi-bakers-sub').textContent = 'ì „ì²´ ' + data.bakers.length + 'ëª…';
  document.getElementById('kpi-cafes').textContent = goodCafes + 'ê³³';
  document.getElementById('kpi-cafes-sub').textContent = 'ì „ì²´ ' + data.cafes.length + 'ê³³';
  document.getElementById('q-delay').textContent = data.cafes.filter(c=>c.status==='ì§€ì—°').length + 'ê³³ âš ï¸';
  document.getElementById('q-dev').textContent = data.devs.length + 'ì¢…';
  document.getElementById('q-unpaid').textContent = data.bakers.filter(b=>b.thisMonth===0).length + 'ëª…';
  const avg = data.cafes.length ? Math.round(data.cafes.reduce((a,c)=>a+c.amount,0)/data.cafes.length) : 0;
  document.getElementById('q-avg').textContent = fmt(avg);
}

// â”€â”€ ë² ì´ì»¤ í…Œì´ë¸” â”€â”€
function renderBakerTable() {
  const tbody = document.getElementById('baker-tbody');
  tbody.innerHTML = '';
  let sumPaid = 0, sumTotal = 0;
  data.bakers.forEach(b => {
    sumPaid += b.thisMonth; sumTotal += b.total;
    const tr = document.createElement('tr');

    const tdName = document.createElement('td');
    tdName.style.fontWeight = '600';
    tdName.appendChild(editable(b.name, v => b.name = v));

    const tdSpec = document.createElement('td');
    tdSpec.appendChild(editable(b.specialty, v => b.specialty = v));

    const tdStatus = document.createElement('td');
    tdStatus.appendChild(statusSelect(b.status, STATUS_BAKER, v => b.status = v));

    const tdThis = document.createElement('td');
    tdThis.style.fontWeight = '700';
    const eThis = editable(b.thisMonth, v => { b.thisMonth = v; b.total += (v - b.thisMonth); }, 'number');
    eThis.textContent = b.thisMonth;
    tdThis.appendChild(eThis);
    tdThis.insertAdjacentHTML('beforeend', '<span style="color:var(--text-muted);font-size:11px"> ì›</span>');

    const tdTotal = document.createElement('td');
    const eTotal = editable(b.total, v => b.total = v, 'number');
    eTotal.textContent = b.total;
    tdTotal.appendChild(eTotal);
    tdTotal.insertAdjacentHTML('beforeend', '<span style="color:var(--text-muted);font-size:11px"> ì›</span>');

    const tdFee = document.createElement('td');
    tdFee.style.cssText = 'color:var(--brown-light);font-weight:600';
    tdFee.textContent = b.thisMonth > 0 ? fmt(Math.round(b.thisMonth * 0.3)) : '-';

    const tdDel = document.createElement('td');
    const del = document.createElement('button');
    del.className = 'btn-del'; del.textContent = 'âœ•';
    del.onclick = () => { data.bakers = data.bakers.filter(x => x.id !== b.id); markChanged(); render(); };
    tdDel.appendChild(del);

    tr.append(tdName, tdSpec, tdStatus, tdThis, tdTotal, tdFee, tdDel);
    tbody.appendChild(tr);
  });
  const sumFee = Math.round(sumPaid * 0.3);
  document.getElementById('foot-paid').textContent = fmt(sumPaid);
  document.getElementById('foot-total').textContent = fmt(sumTotal);
  document.getElementById('foot-fee').textContent = fmt(sumFee);
}

function addBaker() {
  data.bakers.push({ id: nextId++, name:"ìƒˆ ë² ì´ì»¤", specialty:"í’ˆëª© ì…ë ¥", status:"í™œì„±", thisMonth:0, total:0 });
  markChanged(); render();
}

// â”€â”€ ê°œë°œ ë¦¬ìŠ¤íŠ¸ â”€â”€
function renderDevList() {
  const list = document.getElementById('dev-list');
  list.innerHTML = '';
  data.devs.forEach(d => {
    const div = document.createElement('div');
    div.className = 'dev-item';

    const top = document.createElement('div'); top.className = 'dev-top';
    const left = document.createElement('div');

    const nameEl = document.createElement('div'); nameEl.className = 'dev-name';
    nameEl.appendChild(editable(d.item, v => d.item = v));
    const metaEl = document.createElement('div'); metaEl.className = 'dev-meta';
    metaEl.textContent = 'ë‹´ë‹¹: ';
    metaEl.appendChild(editable(d.baker, v => d.baker = v));
    metaEl.insertAdjacentText('beforeend', ' Â· ë§ˆê°: ');
    metaEl.appendChild(editable(d.deadline, v => d.deadline = v));

    left.append(nameEl, metaEl);

    const right = document.createElement('div'); right.className = 'dev-right';

    // stage select
    const stageSel = document.createElement('select');
    stageSel.className = 'edit-select';
    stageSel.style.cssText = 'background:' + (STAGE_COLORS[d.stage]||'#EEE') + ';color:#FFF8F0;border-color:transparent';
    STAGES.forEach(s => {
      const o = document.createElement('option'); o.value = s; o.textContent = s;
      if(s === d.stage) o.selected = true;
      stageSel.appendChild(o);
    });
    stageSel.addEventListener('change', () => { d.stage = stageSel.value; markChanged(); render(); });

    // progress
    const pct = document.createElement('span');
    pct.style.cssText = 'font-size:14px;font-weight:700;color:var(--brown-light)';
    const pEl = editable(d.progress, v => { d.progress = Math.min(100, Math.max(0, v)); }, 'number');
    pEl.textContent = d.progress;
    pct.appendChild(pEl);
    pct.insertAdjacentText('beforeend', '%');

    const del = document.createElement('button');
    del.className = 'btn-del'; del.textContent = 'âœ•';
    del.onclick = () => { data.devs = data.devs.filter(x => x.id !== d.id); markChanged(); render(); };

    right.append(stageSel, pct, del);
    top.append(left, right);

    const bar = document.createElement('div'); bar.className = 'progress-wrap';
    const fill = document.createElement('div'); fill.className = 'progress-bar';
    fill.style.width = d.progress + '%';
    bar.appendChild(fill);

    const note = document.createElement('div'); note.className = 'dev-note';
    note.textContent = 'ğŸ“ ';
    note.appendChild(editable(d.note, v => d.note = v));

    div.append(top, bar, note);
    list.appendChild(div);
  });
}

function addDev() {
  data.devs.push({ id: nextId++, baker:"ë² ì´ì»¤ëª…", item:"ì‹ ê·œ ê°œë°œ í’ˆëª©", stage:"ê¸°íš", progress:0, deadline:"", note:"ë©”ëª¨ ì…ë ¥" });
  markChanged(); render();
}

// â”€â”€ ë‹¨ê³„ ìš”ì•½ â”€â”€
function renderStageSummary() {
  const el = document.getElementById('stage-summary');
  el.innerHTML = '';
  STAGES.slice(0,4).forEach(s => {
    const cnt = data.devs.filter(d => d.stage === s).length;
    el.innerHTML += `<div class="stage-mini"><div class="stage-dot" style="background:${STAGE_COLORS[s]}"></div><div class="stage-count">${cnt}</div><div class="stage-label">${s}</div></div>`;
  });
}

// â”€â”€ ì¹´í˜ í…Œì´ë¸” â”€â”€
function renderCafeTable() {
  const tbody = document.getElementById('cafe-tbody');
  tbody.innerHTML = '';
  let sum = 0;
  data.cafes.forEach(c => {
    sum += c.amount;
    const tr = document.createElement('tr');

    const make = (val, cb) => { const td = document.createElement('td'); td.appendChild(editable(val, cb)); return td; };

    const tdName = document.createElement('td');
    tdName.style.fontWeight = '700';
    tdName.textContent = 'â˜• ';
    tdName.appendChild(editable(c.name, v => c.name = v));

    const tdStatus = document.createElement('td');
    tdStatus.appendChild(statusSelect(c.status, STATUS_CAFE, v => c.status = v));

    const tdAmt = document.createElement('td');
    tdAmt.style.fontWeight = '600';
    const eAmt = editable(c.amount, v => c.amount = v, 'number');
    eAmt.textContent = c.amount;
    tdAmt.appendChild(eAmt);
    tdAmt.insertAdjacentHTML('beforeend','<span style="color:var(--text-muted);font-size:11px"> ì›</span>');

    const tdDel = document.createElement('td');
    const del = document.createElement('button');
    del.className = 'btn-del'; del.textContent = 'âœ•';
    del.onclick = () => { data.cafes = data.cafes.filter(x => x.id !== c.id); markChanged(); render(); };
    tdDel.appendChild(del);

    tr.append(
      tdName,
      make(c.region, v => c.region = v),
      make(c.baker, v => c.baker = v),
      make(c.item, v => c.item = v),
      make(c.freq, v => c.freq = v),
      make(c.lastDate, v => c.lastDate = v),
      tdAmt, tdStatus, tdDel
    );
    tbody.appendChild(tr);
  });
  document.getElementById('cafe-foot-total').textContent = fmt(sum);
}

function renderCafeCards() {
  const el = document.getElementById('cafe-cards');
  el.innerHTML = '';
  data.cafes.forEach(c => {
    const isDelay = c.status === 'ì§€ì—°';
    el.innerHTML += `
      <div class="cafe-card ${isDelay ? 'delay' : ''}">
        <div class="cafe-card-top">
          <span class="cafe-card-name">â˜• ${c.name}</span>
          <span class="badge ${isDelay ? 'badge-red' : 'badge-green'}">${c.status}</span>
        </div>
        <div class="cafe-card-detail">ğŸ“ ${c.region} Â· ğŸ‘©â€ğŸ³ ${c.baker}</div>
        <div class="cafe-card-detail">ğŸ¥ ${c.item} (${c.freq})</div>
        <div class="cafe-card-amount">${fmt(c.amount)}/ì›”</div>
      </div>`;
  });
}

function addCafe() {
  data.cafes.push({ id: nextId++, name:"ìƒˆ ì¹´í˜", region:"ì§€ì—­", baker:"ë² ì´ì»¤ëª…", item:"ë‚©í’ˆ í’ˆëª©", freq:"ì£¼ 1íšŒ", lastDate:"", amount:0, status:"ì •ìƒ" });
  markChanged(); render();
}

// â”€â”€ ì°¨íŠ¸ â”€â”€
function renderCharts() {
  const months = data.monthly.map(m => m.month);
  const paid   = data.monthly.map(m => m.paid);
  const fee    = data.monthly.map(m => Math.round(m.paid * 0.3));

  const pieLabels = data.bakers.filter(b=>b.thisMonth>0).map(b=>b.name);
  const pieVals   = data.bakers.filter(b=>b.thisMonth>0).map(b=>b.thisMonth);
  const PIE_COLORS = ['#C97B3A','#E8B87A','#6B4226','#A0522D','#D4956A'];

  const chartDefs = [
    { id:'chart-bar',  type:'bar',    labels:months, datasets:[{label:'ì§€ê¸‰ì•¡',data:paid,backgroundColor:'#C97B3A',borderRadius:4},{label:'ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ',data:fee,backgroundColor:'#E8B87A',borderRadius:4}], yFmt: v=>v/10000+'ë§Œ' },
    { id:'chart-pie',  type:'doughnut', labels:pieLabels, datasets:[{data:pieVals,backgroundColor:PIE_COLORS,borderWidth:0}], legend:'bottom' },
    { id:'chart-line', type:'line',   labels:months, datasets:[{label:'ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ',data:fee,borderColor:'#C97B3A',backgroundColor:'rgba(201,123,58,0.1)',fill:true,tension:0.4,pointRadius:4,pointBackgroundColor:'#C97B3A'}], yFmt: v=>v/10000+'ë§Œ' },
    { id:'chart-bar2', type:'bar',    labels:months, datasets:[{label:'ì§€ê¸‰ì•¡',data:paid,backgroundColor:'#C97B3A',borderRadius:4},{label:'ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ',data:fee,backgroundColor:'#E8B87A',borderRadius:4}], yFmt: v=>v/10000+'ë§Œ' },
  ];

  chartDefs.forEach(def => {
    if(charts[def.id]) { charts[def.id].destroy(); }
    const ctx = document.getElementById(def.id);
    if(!ctx) return;
    charts[def.id] = new Chart(ctx, {
      type: def.type,
      data: { labels: def.labels, datasets: def.datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: def.legend || 'top', labels: { font:{size:11} } },
          tooltip: { callbacks: { label: ctx => def.yFmt ? 'â‚©'+(ctx.raw).toLocaleString() : ctx.raw } }
        },
        scales: def.type === 'doughnut' ? {} : {
          y: { ticks: { callback: def.yFmt || (v=>v), font:{size:10} }, grid: { color:'#EEE0D0' } },
          x: { ticks: { font:{size:11} }, grid: { display:false } }
        }
      }
    });
  });
}

function switchTab(name, btn) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  btn.classList.add('active');
  setTimeout(renderCharts, 50);
}

// â”€â”€ ì´ˆê¸° ë Œë” â”€â”€
render();
</script>
</body>
</html>
